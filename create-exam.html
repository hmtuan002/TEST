<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo đề thi - Thi Thử Văn Học</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8fafc;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .question-item {
            transition: all 0.3s ease;
        }
        .question-item:hover {
            background-color: #f3f4f6;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
    </style>
</head>
<body>
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-book-open text-blue-600 text-2xl"></i>
                <span class="text-xl font-bold text-gray-800">Thi Thử Văn Học</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-home"></i> Trang chủ
                </a>
                <button id="logout-btn" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-800">Tạo đề thi mới</h1>
                <p class="text-gray-600 mt-1">Tạo đề thi với nhiều tùy chọn khác nhau</p>
            </div>
            
            <div class="flex border-b border-gray-200">
                <button id="tab1-btn" class="tab-btn px-6 py-3 font-medium text-gray-600 active">Thông tin cơ bản</button>
                <button id="tab2-btn" class="tab-btn px-6 py-3 font-medium text-gray-600">Tạo câu hỏi</button>
                <button id="tab3-btn" class="tab-btn px-6 py-3 font-medium text-gray-600">Cài đặt bổ sung</button>
            </div>
            
            <form id="exam-form" class="p-6">
                <!-- Tab 1: Thông tin cơ bản -->
                <div id="tab1-content" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="exam-title" class="block text-sm font-medium text-gray-700 mb-1">Tiêu đề đề thi</label>
                            <input type="text" id="exam-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="exam-time" class="block text-sm font-medium text-gray-700 mb-1">Thời gian làm bài (phút)</label>
                            <input type="number" id="exam-time" min="1" value="60" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="exam-description" class="block text-sm font-medium text-gray-700 mb-1">Mô tả đề thi</label>
                            <textarea id="exam-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phương thức tạo đề</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input id="manual-method" type="radio" name="creation-method" value="manual" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                    <label for="manual-method" class="ml-2 text-sm text-gray-700">Tạo thủ công</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="ai-method" type="radio" name="creation-method" value="ai" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                    <label for="ai-method" class="ml-2 text-sm text-gray-700">Tạo bằng AI</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="word-method" type="radio" name="creation-method" value="word" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                    <label for="word-method" class="ml-2 text-sm text-gray-700">Nhập từ file Word</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button type="button" id="next-to-tab2" class="btn-primary">Tiếp theo</button>
                    </div>
                </div>
                
                <!-- Tab 2: Tạo câu hỏi -->
                <div id="tab2-content" class="tab-content">
                    <div id="manual-creation" class="creation-method">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-800">Danh sách câu hỏi</h2>
                                <button type="button" id="add-question" class="btn-primary">
                                    <i class="fas fa-plus mr-2"></i> Thêm câu hỏi
                                </button>
                            </div>
                            
                            <div id="questions-list" class="space-y-4">
                                <!-- Câu hỏi sẽ được thêm vào đây -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="ai-creation" class="creation-method hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-info-circle text-blue-500"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">Nhập mô tả chi tiết về đề thi bạn muốn tạo. AI sẽ phân tích và tạo đề thi phù hợp.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="ai-prompt" class="block text-sm font-medium text-gray-700 mb-1">Mô tả đề thi</label>
                            <textarea id="ai-prompt" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ví dụ: Tạo đề thi văn học lớp 12 với 5 câu hỏi trắc nghiệm về tác phẩm 'Vợ chồng A Phủ' và 2 câu tự luận ngắn phân tích nhân vật Mị..."></textarea>
                        </div>
                        
                        <div class="flex justify-between">
                            <button type="button" id="back-to-tab1-ai" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Quay lại</button>
                            <button type="button" id="generate-ai-exam" class="btn-primary">
                                <i class="fas fa-magic mr-2"></i> Tạo đề bằng AI
                            </button>
                        </div>
                    </div>
                    
                    <div id="word-creation" class="creation-method hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-info-circle text-blue-500"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">Tải lên file Word (.docx) chứa đề thi. Hệ thống sẽ tự động chuyển đổi thành đề thi trực tuyến.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tải lên file Word</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                                <div class="space-y-1 text-center">
                                    <div class="flex text-sm text-gray-600">
                                        <label for="word-file" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                            <span>Tải lên file</span>
                                            <input id="word-file" name="word-file" type="file" accept=".docx" class="sr-only">
                                        </label>
                                        <p class="pl-1">hoặc kéo thả vào đây</p>
                                    </div>
                                    <p class="text-xs text-gray-500">DOCX lên đến 10MB</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between">
                            <button type="button" id="back-to-tab1-word" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Quay lại</button>
                            <button type="button" id="process-word-file" class="btn-primary">
                                <i class="fas fa-file-word mr-2"></i> Xử lý file Word
                            </button>
                        </div>
                    </div>
                    
                    <div id="preview-section" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Xem trước đề thi</h2>
                            <button type="button" id="edit-questions" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit mr-1"></i> Chỉnh sửa
                            </button>
                        </div>
                        
                        <div id="exam-preview" class="bg-white border border-gray-200 rounded-lg p-6">
                            <!-- Nội dung xem trước sẽ được thêm vào đây -->
                        </div>
                        
                        <div class="flex justify-between mt-6">
                            <button type="button" id="back-to-tab2" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Quay lại</button>
                            <button type="button" id="next-to-tab3" class="btn-primary">Tiếp theo</button>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 3: Cài đặt bổ sung -->
                <div id="tab3-content" class="tab-content">
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Cài đặt chống gian lận</h2>
                        
                        <div class="space-y-4">
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="anti-copy" name="anti-copy" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="anti-copy" class="font-medium text-gray-700">Chống sao chép nội dung</label>
                                    <p class="text-gray-500">Tự động nộp bài nếu phát hiện sao chép nội dung từ bên ngoài</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="anti-switch-tab" name="anti-switch-tab" type="checkbox" checked class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="anti-switch-tab" class="font-medium text-gray-700">Chống chuyển tab</label>
                                    <p class="text-gray-500">Tự động nộp bài nếu thí sinh chuyển sang tab khác hoặc mở ứng dụng khác</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="enable-notifications" name="enable-notifications" type="checkbox" checked class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="enable-notifications" class="font-medium text-gray-700">Thông báo gian lận</label>
                                    <p class="text-gray-500">Gửi thông báo khi phát hiện gian lận</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button type="button" id="back-to-tab2-final" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Quay lại</button>
                        <button type="button" id="create-exam-btn" class="btn-primary">
                            <i class="fas fa-save mr-2"></i> Tạo đề thi
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal thêm câu hỏi -->
    <div id="question-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Thêm câu hỏi mới</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="question-type" class="block text-sm font-medium text-gray-700 mb-1">Loại câu hỏi</label>
                        <select id="question-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="multiple-choice">Trắc nghiệm (A, B, C, D)</option>
                            <option value="true-false">Đúng/Sai</option>
                            <option value="short-answer">Trả lời ngắn</option>
                            <option value="essay">Tự luận</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="question-content" class="block text-sm font-medium text-gray-700 mb-1">Nội dung câu hỏi</label>
                        <textarea id="question-content" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <div id="multiple-choice-options" class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Các lựa chọn</label>
                        <div class="flex items-center">
                            <input type="radio" name="correct-answer" value="A" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <input type="text" id="option-a" placeholder="Lựa chọn A" class="ml-2 w-full px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="correct-answer" value="B" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <input type="text" id="option-b" placeholder="Lựa chọn B" class="ml-2 w-full px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="correct-answer" value="C" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <input type="text" id="option-c" placeholder="Lựa chọn C" class="ml-2 w-full px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="correct-answer" value="D" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <input type="text" id="option-d" placeholder="Lựa chọn D" class="ml-2 w-full px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div id="true-false-options" class="hidden space-y-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Đáp án</label>
                        <div class="flex items-center">
                            <input type="radio" name="correct-tf-answer" value="true" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label class="ml-2 text-sm text-gray-700">Đúng</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="correct-tf-answer" value="false" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label class="ml-2 text-sm text-gray-700">Sai</label>
                        </div>
                    </div>
                    
                    <div id="short-answer-options" class="hidden">
                        <label for="short-answer" class="block text-sm font-medium text-gray-700 mb-1">Đáp án mẫu</label>
                        <textarea id="short-answer" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <div id="essay-options" class="hidden">
                        <label for="essay-answer" class="block text-sm font-medium text-gray-700 mb-1">Đáp án mẫu</label>
                        <textarea id="essay-answer" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <div>
                        <label for="question-points" class="block text-sm font-medium text-gray-700 mb-1">Điểm số</label>
                        <input type="number" id="question-points" min="0" step="0.5" value="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-question" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Hủy bỏ</button>
                    <button type="button" id="save-question" class="btn-primary">Lưu câu hỏi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal kết quả tạo đề -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="text-center mb-6">
                    <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Tạo đề thi thành công!</h3>
                    <p class="text-gray-600">Đề thi của bạn đã được lưu và sẵn sàng để chia sẻ</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Link chia sẻ</label>
                    <div class="flex">
                        <input type="text" id="share-link" readonly class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button id="copy-link" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="text-center mb-6">
                    <p class="text-sm text-gray-600 mb-2">Hoặc quét mã QR</p>
                    <div id="qrcode" class="flex justify-center"></div>
                </div>
                
                <div class="flex justify-center">
                    <button id="close-result-modal" class="btn-primary">Hoàn thành</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAu4xlTa51eZrb9b2xhWKkbOv-L8gpPDPg",
            authDomain: "xta-tl.firebaseapp.com",
            projectId: "xta-tl",
            storageBucket: "xta-tl.appspot.com",
            messagingSenderId: "1049275322449",
            appId: "1:1049275322449:web:9ad1ed1986bb1712942870",
            measurementId: "G-MC2V2CK2XF"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Kiểm tra đăng nhập
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Đăng xuất
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        });

        // Quản lý tabs
        const tab1Btn = document.getElementById('tab1-btn');
        const tab2Btn = document.getElementById('tab2-btn');
        const tab3Btn = document.getElementById('tab3-btn');
        const tab1Content = document.getElementById('tab1-content');
        const tab2Content = document.getElementById('tab2-content');
        const tab3Content = document.getElementById('tab3-content');

        tab1Btn.addEventListener('click', () => {
            tab1Btn.classList.add('active');
            tab2Btn.classList.remove('active');
            tab3Btn.classList.remove('active');
            tab1Content.classList.add('active');
            tab2Content.classList.remove('active');
            tab3Content.classList.remove('active');
        });

        tab2Btn.addEventListener('click', () => {
            tab2Btn.classList.add('active');
            tab1Btn.classList.remove('active');
            tab3Btn.classList.remove('active');
            tab2Content.classList.add('active');
            tab1Content.classList.remove('active');
            tab3Content.classList.remove('active');
        });

        tab3Btn.addEventListener('click', () => {
            tab3Btn.classList.add('active');
            tab1Btn.classList.remove('active');
            tab2Btn.classList.remove('active');
            tab3Content.classList.add('active');
            tab1Content.classList.remove('active');
            tab2Content.classList.remove('active');
        });

        // Chuyển tab khi nhấn nút tiếp theo
        document.getElementById('next-to-tab2').addEventListener('click', () => {
            const examTitle = document.getElementById('exam-title').value;
            const examTime = document.getElementById('exam-time').value;
            
            if (!examTitle || !examTime) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thiếu thông tin',
                    text: 'Vui lòng điền đầy đủ tiêu đề và thời gian làm bài',
                });
                return;
            }
            
            const creationMethod = document.querySelector('input[name="creation-method"]:checked').value;
            
            // Hiển thị phần tạo câu hỏi phù hợp
            document.getElementById('manual-creation').classList.add('hidden');
            document.getElementById('ai-creation').classList.add('hidden');
            document.getElementById('word-creation').classList.add('hidden');
            
            if (creationMethod === 'manual') {
                document.getElementById('manual-creation').classList.remove('hidden');
            } else if (creationMethod === 'ai') {
                document.getElementById('ai-creation').classList.remove('hidden');
            } else if (creationMethod === 'word') {
                document.getElementById('word-creation').classList.remove('hidden');
            }
            
            tab2Btn.click();
        });

        document.getElementById('next-to-tab3').addEventListener('click', () => {
            tab3Btn.click();
        });

        // Quay lại tab trước đó
        document.getElementById('back-to-tab1-ai').addEventListener('click', () => {
            tab1Btn.click();
        });

        document.getElementById('back-to-tab1-word').addEventListener('click', () => {
            tab1Btn.click();
        });

        document.getElementById('back-to-tab2').addEventListener('click', () => {
            tab2Btn.click();
        });

        document.getElementById('back-to-tab2-final').addEventListener('click', () => {
            tab2Btn.click();
        });

        // Quản lý phương thức tạo đề
        document.querySelectorAll('input[name="creation-method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'ai') {
                    document.getElementById('exam-description').placeholder = "Mô tả chi tiết sẽ giúp AI tạo đề thi chính xác hơn";
                } else {
                    document.getElementById('exam-description').placeholder = "";
                }
            });
        });

        // Modal thêm câu hỏi
        const questionModal = document.getElementById('question-modal');
        const closeModal = document.getElementById('close-modal');
        const cancelQuestion = document.getElementById('cancel-question');
        const addQuestionBtn = document.getElementById('add-question');
        const questionType = document.getElementById('question-type');
        const questionContent = document.getElementById('question-content');
        const saveQuestionBtn = document.getElementById('save-question');
        const questionsList = document.getElementById('questions-list');
        
        // Hiển thị các tùy chọn theo loại câu hỏi
        questionType.addEventListener('change', (e) => {
            document.getElementById('multiple-choice-options').classList.add('hidden');
            document.getElementById('true-false-options').classList.add('hidden');
            document.getElementById('short-answer-options').classList.add('hidden');
            document.getElementById('essay-options').classList.add('hidden');
            
            if (e.target.value === 'multiple-choice') {
                document.getElementById('multiple-choice-options').classList.remove('hidden');
            } else if (e.target.value === 'true-false') {
                document.getElementById('true-false-options').classList.remove('hidden');
            } else if (e.target.value === 'short-answer') {
                document.getElementById('short-answer-options').classList.remove('hidden');
            } else if (e.target.value === 'essay') {
                document.getElementById('essay-options').classList.remove('hidden');
            }
        });

        // Mở modal thêm câu hỏi
        addQuestionBtn.addEventListener('click', () => {
            // Reset form
            questionContent.value = '';
            document.getElementById('option-a').value = '';
            document.getElementById('option-b').value = '';
            document.getElementById('option-c').value = '';
            document.getElementById('option-d').value = '';
            document.getElementById('short-answer').value = '';
            document.getElementById('essay-answer').value = '';
            document.getElementById('question-points').value = '1';
            
            // Hiển thị lại options mặc định
            questionType.value = 'multiple-choice';
            document.getElementById('multiple-choice-options').classList.remove('hidden');
            document.getElementById('true-false-options').classList.add('hidden');
            document.getElementById('short-answer-options').classList.add('hidden');
            document.getElementById('essay-options').classList.add('hidden');
            
            questionModal.classList.remove('hidden');
        });

        // Đóng modal
        closeModal.addEventListener('click', () => {
            questionModal.classList.add('hidden');
        });

        cancelQuestion.addEventListener('click', () => {
            questionModal.classList.add('hidden');
        });

        // Lưu câu hỏi
        saveQuestionBtn.addEventListener('click', () => {
            const type = questionType.value;
            const content = questionContent.value;
            const points = document.getElementById('question-points').value;
            
            if (!content) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thiếu nội dung',
                    text: 'Vui lòng nhập nội dung câu hỏi',
                });
                return;
            }
            
            let answerOptions = [];
            let correctAnswer = '';
            
            if (type === 'multiple-choice') {
                const optionA = document.getElementById('option-a').value;
                const optionB = document.getElementById('option-b').value;
                const optionC = document.getElementById('option-c').value;
                const optionD = document.getElementById('option-d').value;
                
                if (!optionA || !optionB || !optionC || !optionD) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Thiếu lựa chọn',
                        text: 'Vui lòng điền đầy đủ các lựa chọn',
                    });
                    return;
                }
                
                const selectedOption = document.querySelector('input[name="correct-answer"]:checked');
                if (!selectedOption) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Thiếu đáp án',
                        text: 'Vui lòng chọn đáp án đúng',
                    });
                    return;
                }
                
                answerOptions = [
                    { option: 'A', text: optionA },
                    { option: 'B', text: optionB },
                    { option: 'C', text: optionC },
                    { option: 'D', text: optionD }
                ];
                correctAnswer = selectedOption.value;
            } else if (type === 'true-false') {
                const selectedOption = document.querySelector('input[name="correct-tf-answer"]:checked');
                if (!selectedOption) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Thiếu đáp án',
                        text: 'Vui lòng chọn đáp án đúng',
                    });
                    return;
                }
                correctAnswer = selectedOption.value;
            } else if (type === 'short-answer') {
                correctAnswer = document.getElementById('short-answer').value;
                if (!correctAnswer) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Thiếu đáp án',
                        text: 'Vui lòng nhập đáp án mẫu',
                    });
                    return;
                }
            } else if (type === 'essay') {
                correctAnswer = document.getElementById('essay-answer').value;
                if (!correctAnswer) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Thiếu đáp án',
                        text: 'Vui lòng nhập đáp án mẫu',
                    });
                    return;
                }
            }
            
            const questionId = Date.now().toString();
            
            const questionItem = document.createElement('div');
            questionItem.className = 'question-item bg-white border border-gray-200 rounded-lg p-4';
            questionItem.dataset.id = questionId;
            questionItem.dataset.type = type;
            questionItem.dataset.content = content;
            questionItem.dataset.points = points;
            questionItem.dataset.correctAnswer = correctAnswer;
            
            if (type === 'multiple-choice') {
                questionItem.dataset.options = JSON.stringify(answerOptions);
            }
            
            let questionHtml = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-medium text-gray-800">${content}</h4>
                        <p class="text-sm text-gray-600 mt-1">Loại: ${getQuestionTypeName(type)} | Điểm: ${points}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-question text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-question text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            questionItem.innerHTML = questionHtml;
            questionsList.appendChild(questionItem);
            
            questionModal.classList.add('hidden');
            
            // Thêm sự kiện cho nút xóa và sửa
            questionItem.querySelector('.delete-question').addEventListener('click', () => {
                questionItem.remove();
            });
            
            questionItem.querySelector('.edit-question').addEventListener('click', () => {
                editQuestion(questionItem);
            });
            
            // Hiển thị nút xem trước nếu có ít nhất 1 câu hỏi
            if (questionsList.children.length > 0) {
                document.getElementById('preview-section').classList.remove('hidden');
            }
        });

        function getQuestionTypeName(type) {
            switch (type) {
                case 'multiple-choice': return 'Trắc nghiệm';
                case 'true-false': return 'Đúng/Sai';
                case 'short-answer': return 'Trả lời ngắn';
                case 'essay': return 'Tự luận';
                default: return '';
            }
        }

        function editQuestion(questionItem) {
            const type = questionItem.dataset.type;
            const content = questionItem.dataset.content;
            const points = questionItem.dataset.points;
            const correctAnswer = questionItem.dataset.correctAnswer;
            
            // Điền thông tin vào modal
            questionType.value = type;
            questionContent.value = content;
            document.getElementById('question-points').value = points;
            
            // Hiển thị options phù hợp
            document.getElementById('multiple-choice-options').classList.add('hidden');
            document.getElementById('true-false-options').classList.add('hidden');
            document.getElementById('short-answer-options').classList.add('hidden');
            document.getElementById('essay-options').classList.add('hidden');
            
            if (type === 'multiple-choice') {
                document.getElementById('multiple-choice-options').classList.remove('hidden');
                const options = JSON.parse(questionItem.dataset.options);
                document.getElementById('option-a').value = options[0].text;
                document.getElementById('option-b').value = options[1].text;
                document.getElementById('option-c').value = options[2].text;
                document.getElementById('option-d').value = options[3].text;
                document.querySelector(`input[name="correct-answer"][value="${correctAnswer}"]`).checked = true;
            } else if (type === 'true-false') {
                document.getElementById('true-false-options').classList.remove('hidden');
                document.querySelector(`input[name="correct-tf-answer"][value="${correctAnswer}"]`).checked = true;
            } else if (type === 'short-answer') {
                document.getElementById('short-answer-options').classList.remove('hidden');
                document.getElementById('short-answer').value = correctAnswer;
            } else if (type === 'essay') {
                document.getElementById('essay-options').classList.remove('hidden');
                document.getElementById('essay-answer').value = correctAnswer;
            }
            
            // Mở modal
            questionModal.classList.remove('hidden');
            
            // Thay đổi hành vi nút lưu để cập nhật thay vì thêm mới
            saveQuestionBtn.textContent = 'Cập nhật';
            saveQuestionBtn.removeEventListener('click', saveQuestionHandler);
            
            function saveQuestionHandler() {
                const newType = questionType.value;
                const newContent = questionContent.value;
                const newPoints = document.getElementById('question-points').value;
                
                if (!newContent) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Thiếu nội dung',
                        text: 'Vui lòng nhập nội dung câu hỏi',
                    });
                    return;
                }
                
                let newAnswerOptions = [];
                let newCorrectAnswer = '';
                
                if (newType === 'multiple-choice') {
                    const optionA = document.getElementById('option-a').value;
                    const optionB = document.getElementById('option-b').value;
                    const optionC = document.getElementById('option-c').value;
                    const optionD = document.getElementById('option-d').value;
                    
                    if (!optionA || !optionB || !optionC || !optionD) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Thiếu lựa chọn',
                            text: 'Vui lòng điền đầy đủ các lựa chọn',
                        });
                        return;
                    }
                    
                    const selectedOption = document.querySelector('input[name="correct-answer"]:checked');
                    if (!selectedOption) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Thiếu đáp án',
                            text: 'Vui lòng chọn đáp án đúng',
                        });
                        return;
                    }
                    
                    newAnswerOptions = [
                        { option: 'A', text: optionA },
                        { option: 'B', text: optionB },
                        { option: 'C', text: optionC },
                        { option: 'D', text: optionD }
                    ];
                    newCorrectAnswer = selectedOption.value;
                } else if (newType === 'true-false') {
                    const selectedOption = document.querySelector('input[name="correct-tf-answer"]:checked');
                    if (!selectedOption) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Thiếu đáp án',
                            text: 'Vui lòng chọn đáp án đúng',
                        });
                        return;
                    }
                    newCorrectAnswer = selectedOption.value;
                } else if (newType === 'short-answer') {
                    newCorrectAnswer = document.getElementById('short-answer').value;
                    if (!newCorrectAnswer) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Thiếu đáp án',
                            text: 'Vui lòng nhập đáp án mẫu',
                        });
                        return;
                    }
                } else if (newType === 'essay') {
                    newCorrectAnswer = document.getElementById('essay-answer').value;
                    if (!newCorrectAnswer) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Thiếu đáp án',
                            text: 'Vui lòng nhập đáp án mẫu',
                        });
                        return;
                    }
                }
                
                // Cập nhật thông tin câu hỏi
                questionItem.dataset.type = newType;
                questionItem.dataset.content = newContent;
                questionItem.dataset.points = newPoints;
                questionItem.dataset.correctAnswer = newCorrectAnswer;
                
                if (newType === 'multiple-choice') {
                    questionItem.dataset.options = JSON.stringify(newAnswerOptions);
                }
                
                let questionHtml = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${newContent}</h4>
                            <p class="text-sm text-gray-600 mt-1">Loại: ${getQuestionTypeName(newType)} | Điểm: ${newPoints}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-question text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-question text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                questionItem.innerHTML = questionHtml;
                
                // Thêm lại sự kiện
                questionItem.querySelector('.delete-question').addEventListener('click', () => {
                    questionItem.remove();
                });
                
                questionItem.querySelector('.edit-question').addEventListener('click', () => {
                    editQuestion(questionItem);
                });
                
                questionModal.classList.add('hidden');
                saveQuestionBtn.textContent = 'Lưu câu hỏi';
                saveQuestionBtn.addEventListener('click', saveQuestionHandler);
            }
            
            saveQuestionBtn.addEventListener('click', saveQuestionHandler);
        }

        // Xem trước đề thi
        document.getElementById('edit-questions').addEventListener('click', () => {
            document.getElementById('preview-section').classList.add('hidden');
        });

        document.getElementById('next-to-tab3').addEventListener('click', () => {
            const examPreview = document.getElementById('exam-preview');
            examPreview.innerHTML = '';
            
            // Thêm thông tin đề thi
            const examTitle = document.getElementById('exam-title').value;
            const examTime = document.getElementById('exam-time').value;
            const examDescription = document.getElementById('exam-description').value;
            
            const examInfoHtml = `
                <div class="mb-6 pb-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${examTitle}</h3>
                    <p class="text-gray-600 mb-2">Thời gian làm bài: ${examTime} phút</p>
                    ${examDescription ? `<p class="text-gray-700">${examDescription}</p>` : ''}
                </div>
            `;
            examPreview.innerHTML += examInfoHtml;
            
            // Thêm các câu hỏi
            const questionItems = document.querySelectorAll('.question-item');
            questionItems.forEach((item, index) => {
                const type = item.dataset.type;
                const content = item.dataset.content;
                const points = item.dataset.points;
                const correctAnswer = item.dataset.correctAnswer;
                
                let questionHtml = `
                    <div class="mb-6 pb-6 border-b border-gray-200 last:border-0">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-medium text-gray-800">Câu ${index + 1}: ${content}</h4>
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${points} điểm</span>
                        </div>
                `;
                
                if (type === 'multiple-choice') {
                    const options = JSON.parse(item.dataset.options);
                    questionHtml += `<div class="space-y-2">`;
                    options.forEach(opt => {
                        questionHtml += `
                            <div class="flex items-center">
                                <input type="radio" name="q${index}" id="q${index}-${opt.option}" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                <label for="q${index}-${opt.option}" class="ml-2 text-gray-700">${opt.option}. ${opt.text}</label>
                            </div>
                        `;
                    });
                    questionHtml += `</div>`;
                } else if (type === 'true-false') {
                    questionHtml += `
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="radio" name="q${index}" id="q${index}-true" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                <label for="q${index}-true" class="ml-2 text-gray-700">Đúng</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" name="q${index}" id="q${index}-false" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                <label for="q${index}-false" class="ml-2 text-gray-700">Sai</label>
                            </div>
                        </div>
                    `;
                } else if (type === 'short-answer') {
                    questionHtml += `
                        <div>
                            <textarea rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nhập câu trả lời ngắn"></textarea>
                        </div>
                    `;
                } else if (type === 'essay') {
                    questionHtml += `
                        <div>
                            <textarea rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nhập bài luận"></textarea>
                        </div>
                    `;
                }
                
                questionHtml += `</div>`;
                examPreview.innerHTML += questionHtml;
            });
            
            tab3Btn.click();
        });

        // Tạo đề bằng AI
        document.getElementById('generate-ai-exam').addEventListener('click', async () => {
            const prompt = document.getElementById('ai-prompt').value;
            if (!prompt) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thiếu mô tả',
                    text: 'Vui lòng nhập mô tả đề thi bạn muốn tạo',
                });
                return;
            }
            
            Swal.fire({
                title: 'Đang tạo đề thi bằng AI...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                // Gọi API Gemini AI
                const API_KEY = "AIzaSyAcZaIvApX_UQKWZzP4uj2J1cCseZ_zkyk";
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                
                const examTitle = document.getElementById('exam-title').value;
                const examTime = document.getElementById('exam-time').value;
                const fullPrompt = `Tạo một đề thi văn học với tiêu đề "${examTitle}", thời gian làm bài ${examTime} phút. Yêu cầu: ${prompt}. 
                Trả về kết quả dưới dạng JSON với cấu trúc sau: 
                {
                    "title": "Tiêu đề đề thi",
                    "timeLimit": số phút,
                    "questions": [
                        {
                            "type": "loại câu hỏi (multiple-choice/true-false/short-answer/essay)",
                            "content": "nội dung câu hỏi",
                            "points": số điểm,
                            "options": [chỉ cho loại multiple-choice],
                            "correctAnswer": "đáp án đúng"
                        }
                    ]
                }`;
                
                const result = await model.generateContent(fullPrompt);
                const response = await result.response;
                const text = response.text();
                
                // Parse JSON từ kết quả AI
                let jsonResponse;
                try {
                    // Xử lý text để lấy phần JSON (Gemini có thể thêm markdown ```json)
                    const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    jsonResponse = JSON.parse(jsonText);
                } catch (e) {
                    console.error('Error parsing AI response:', e);
                    throw new Error('Không thể phân tích kết quả từ AI. Vui lòng thử lại với mô tả chi tiết hơn.');
                }
                
                // Xóa các câu hỏi cũ (nếu có)
                questionsList.innerHTML = '';
                
                // Thêm các câu hỏi từ AI vào danh sách
                jsonResponse.questions.forEach((question, index) => {
                    const questionId = Date.now().toString() + index;
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item bg-white border border-gray-200 rounded-lg p-4';
                    questionItem.dataset.id = questionId;
                    questionItem.dataset.type = question.type;
                    questionItem.dataset.content = question.content;
                    questionItem.dataset.points = question.points;
                    questionItem.dataset.correctAnswer = question.correctAnswer;
                    
                    if (question.type === 'multiple-choice' && question.options) {
                        questionItem.dataset.options = JSON.stringify(question.options);
                    }
                    
                    let questionHtml = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium text-gray-800">${question.content}</h4>
                                <p class="text-sm text-gray-600 mt-1">Loại: ${getQuestionTypeName(question.type)} | Điểm: ${question.points}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-question text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-question text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    questionItem.innerHTML = questionHtml;
                    questionsList.appendChild(questionItem);
                    
                    // Thêm sự kiện cho nút xóa và sửa
                    questionItem.querySelector('.delete-question').addEventListener('click', () => {
                        questionItem.remove();
                    });
                    
                    questionItem.querySelector('.edit-question').addEventListener('click', () => {
                        editQuestion(questionItem);
                    });
                });
                
                Swal.close();
                
                // Hiển thị phần xem trước
                document.getElementById('preview-section').classList.remove('hidden');
                
                // Chuyển sang chế độ tạo thủ công để có thể chỉnh sửa
                document.getElementById('manual-method').checked = true;
                document.getElementById('manual-creation').classList.remove('hidden');
                document.getElementById('ai-creation').classList.add('hidden');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Tạo đề thi thành công!',
                    text: 'Đề thi đã được tạo từ AI. Bạn có thể chỉnh sửa nếu cần.',
                });
            } catch (error) {
                console.error('AI generation error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi khi tạo đề thi',
                    text: error.message || 'Đã xảy ra lỗi khi tạo đề thi bằng AI. Vui lòng thử lại.',
                });
            }
        });

        // Xử lý file Word
        document.getElementById('process-word-file').addEventListener('click', async () => {
            const fileInput = document.getElementById('word-file');
            if (!fileInput.files || fileInput.files.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thiếu file',
                    text: 'Vui lòng chọn file Word để tải lên',
                });
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.docx')) {
                Swal.fire({
                    icon: 'error',
                    title: 'File không hợp lệ',
                    text: 'Vui lòng chọn file có định dạng .docx',
                });
                return;
            }
            
            Swal.fire({
                title: 'Đang xử lý file Word...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                // Đọc nội dung file Word
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                const text = result.value;
                
                // Gọi API Gemini AI để phân tích và chuyển đổi thành đề thi
                const API_KEY = "AIzaSyAcZaIvApX_UQKWZzP4uj2J1cCseZ_zkyk";
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                
                const examTitle = document.getElementById('exam-title').value;
                const examTime = document.getElementById('exam-time').value;
                const fullPrompt = `Tôi có nội dung một đề thi văn học trong file Word. Hãy phân tích và chuyển đổi thành đề thi trực tuyến với tiêu đề "${examTitle}", thời gian làm bài ${examTime} phút. 
                Nội dung file Word: ${text}
                Trả về kết quả dưới dạng JSON với cấu trúc sau: 
                {
                    "title": "Tiêu đề đề thi",
                    "timeLimit": số phút,
                    "questions": [
                        {
                            "type": "loại câu hỏi (multiple-choice/true-false/short-answer/essay)",
                            "content": "nội dung câu hỏi",
                            "points": số điểm,
                            "options": [chỉ cho loại multiple-choice],
                            "correctAnswer": "đáp án đúng"
                        }
                    ]
                }`;
                
                const aiResult = await model.generateContent(fullPrompt);
                const response = await aiResult.response;
                const aiText = response.text();
                
                // Parse JSON từ kết quả AI
                let jsonResponse;
                try {
                    // Xử lý text để lấy phần JSON (Gemini có thể thêm markdown ```json)
                    const jsonText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                    jsonResponse = JSON.parse(jsonText);
                } catch (e) {
                    console.error('Error parsing AI response:', e);
                    throw new Error('Không thể phân tích nội dung file Word. Vui lòng kiểm tra lại định dạng file.');
                }
                
                // Xóa các câu hỏi cũ (nếu có)
                questionsList.innerHTML = '';
                
                // Thêm các câu hỏi từ file Word vào danh sách
                jsonResponse.questions.forEach((question, index) => {
                    const questionId = Date.now().toString() + index;
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item bg-white border border-gray-200 rounded-lg p-4';
                    questionItem.dataset.id = questionId;
                    questionItem.dataset.type = question.type;
                    questionItem.dataset.content = question.content;
                    questionItem.dataset.points = question.points;
                    questionItem.dataset.correctAnswer = question.correctAnswer;
                    
                    if (question.type === 'multiple-choice' && question.options) {
                        questionItem.dataset.options = JSON.stringify(question.options);
                    }
                    
                    let questionHtml = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium text-gray-800">${question.content}</h4>
                                <p class="text-sm text-gray-600 mt-1">Loại: ${getQuestionTypeName(question.type)} | Điểm: ${question.points}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-question text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-question text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    questionItem.innerHTML = questionHtml;
                    questionsList.appendChild(questionItem);
                    
                    // Thêm sự kiện cho nút xóa và sửa
                    questionItem.querySelector('.delete-question').addEventListener('click', () => {
                        questionItem.remove();
                    });
                    
                    questionItem.querySelector('.edit-question').addEventListener('click', () => {
                        editQuestion(questionItem);
                    });
                });
                
                Swal.close();
                
                // Hiển thị phần xem trước
                document.getElementById('preview-section').classList.remove('hidden');
                
                // Chuyển sang chế độ tạo thủ công để có thể chỉnh sửa
                document.getElementById('manual-method').checked = true;
                document.getElementById('manual-creation').classList.remove('hidden');
                document.getElementById('word-creation').classList.add('hidden');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Xử lý file Word thành công!',
                    text: 'Đề thi đã được tạo từ file Word. Bạn có thể chỉnh sửa nếu cần.',
                });
            } catch (error) {
                console.error('Word processing error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi khi xử lý file Word',
                    text: error.message || 'Đã xảy ra lỗi khi xử lý file Word. Vui lòng thử lại.',
                });
            }
        });

        // Tạo đề thi và lưu vào Firestore
        document.getElementById('create-exam-btn').addEventListener('click', async () => {
            const examTitle = document.getElementById('exam-title').value;
            const examTime = parseInt(document.getElementById('exam-time').value);
            const examDescription = document.getElementById('exam-description').value;
            
            const questionItems = document.querySelectorAll('.question-item');
            if (questionItems.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thiếu câu hỏi',
                    text: 'Vui lòng thêm ít nhất một câu hỏi cho đề thi',
                });
                return;
            }
            
            // Lấy cài đặt chống gian lận
            const antiCopy = document.getElementById('anti-copy').checked;
            const antiSwitchTab = document.getElementById('anti-switch-tab').checked;
            const enableNotifications = document.getElementById('enable-notifications').checked;
            
            // Tạo mảng câu hỏi
            const questions = [];
            questionItems.forEach(item => {
                const question = {
                    type: item.dataset.type,
                    content: item.dataset.content,
                    points: parseFloat(item.dataset.points),
                    correctAnswer: item.dataset.correctAnswer
                };
                
                if (item.dataset.type === 'multiple-choice') {
                    question.options = JSON.parse(item.dataset.options);
                }
                
                questions.push(question);
            });
            
            // Tính tổng điểm
            const totalPoints = questions.reduce((sum, q) => sum + q.points, 0);
            
            Swal.fire({
                title: 'Đang tạo đề thi...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Người dùng chưa đăng nhập');
                
                // Tạo ID duy nhất cho đề thi
                const examId = db.collection('exams').doc().id;
                
                // Lưu đề thi vào Firestore
                await db.collection('exams').doc(examId).set({
                    id: examId,
                    title: examTitle,
                    description: examDescription,
                    timeLimit: examTime,
                    totalPoints: totalPoints,
                    questions: questions,
                    antiCheatSettings: {
                        antiCopy: antiCopy,
                        antiSwitchTab: antiSwitchTab,
                        enableNotifications: enableNotifications
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: user.uid,
                    participants: []
                });
                
                // Cập nhật danh sách đề thi của người dùng
                await db.collection('users').doc(user.uid).update({
                    createdExams: firebase.firestore.FieldValue.arrayUnion(examId)
                });
                
                Swal.close();
                
                // Hiển thị modal kết quả với link và QR code
                const shareLink = `${window.location.origin}/take-exam.html?examId=${examId}`;
                document.getElementById('share-link').value = shareLink;
                
                // Tạo QR code
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {
                    text: shareLink,
                    width: 200,
                    height: 200
                });
                
                // Mở modal kết quả
                document.getElementById('result-modal').classList.remove('hidden');
                
                // Copy link khi nhấn nút
                document.getElementById('copy-link').addEventListener('click', () => {
                    const shareLinkInput = document.getElementById('share-link');
                    shareLinkInput.select();
                    document.execCommand('copy');
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã sao chép link!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                });
                
                // Đóng modal kết quả
                document.getElementById('close-result-modal').addEventListener('click', () => {
                    document.getElementById('result-modal').classList.add('hidden');
                    window.location.href = 'manage-exam.html';
                });
            } catch (error) {
                console.error('Error creating exam:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi khi tạo đề thi',
                    text: error.message || 'Đã xảy ra lỗi khi lưu đề thi. Vui lòng thử lại.',
                });
            }
        });
    </script>
</body>
</html>
